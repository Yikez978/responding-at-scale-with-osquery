<!DOCTYPE html>
<html>
  <head>
    <title>DFIR @scale - osquery</title>
    <meta charset="utf-8">

    <link rel="icon" type="image/x-icon" href="https://assets-cdn.github.com/favicon.ico">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/octicons/3.0.1/octicons.css">

    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
        margin-bottom: 0;
      }
      h4{
        font-family: 'Yanone Kaffeesatz';
        font-weight: light;
      }
      i{
        color: #937aff;
      }
      .imgalt { border-radius: 20px; }
      .title {
        font-size: 200%;
        color: #FFF;
        background-color: #321d83;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      /* Reverse slide layout */
      .dark-purple {
        background-color: #321d83;
        color: #777872;
        text-shadow: 0 0 20px #333;
      }
      .dark-purple h1, .dark-purple h2, .dark-purple h3 {
        color: #f3f3f3;
        line-height: 0.8em;
      }
      /* Two-column layout */
      .left-column {
        color: #777;
        width: 20%;
        height: 92%;
        float: left;
      }
      .left-column h2:last-of-type, .left-column h3:last-child {
        color: #000;
      }
      .right-column {
        width: 75%;
        float: right;
        padding-top: 1em;
      }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle, dark-purple

# Responding @ Scale
<img src="https://osquery.io/static/site/img/logo.png">
## osquery for Mass Incident Detection & Response

---

class: center, middle
background-image: url(http://shankman.com/images/imguploader/images/Introduction.png)
# Introductions
## The Natural, Polite Place to Start

---

class: middle
# Kevin Thompson
## <i class="fa fa-building"></i> Incident Responder @ Heroku
## <i class="fa fa-twitter"></i> @blackfist
## <i class="fa fa-exclamation-triangle"></i> I know more about WWE than all of you...

---

class: middle
# Heroku
## <i class="fa fa-angle-right"></i>_"A company that runs apps for you"_
## <i class="fa fa-angle-right"></i>Largest PaaS provider
## <i class="fa fa-angle-right"></i>Tens of thousands of Linux servers in production

---

class: middle
# Scott

## <i class="fa fa-building"></i> DFIR Engineer @ GitHub
## <i class="fa fa-twitter"></i> @sroberts
## <i class="fa fa-exclamation-triangle"></i> I know more about StarWars than all of you...

---

# GitHub
## <i class="fa fa-angle-right"></i>_"Making it easiser to work together than alone"_
## <i class="fa fa-angle-right"></i>Thousands of Linux Servers in Production & Hundreds of Macs

---

class: center, middle
# <b><i>@Scale</i></b> is a rip off...
### _But for a good reason..._

---

class: middle
# A Story in Three Parts
## <i class="fa fa-caret-right"></i> osquery
--

## <i class="fa fa-caret-right"></i> osquery use
--

## <i class="fa fa-caret-right"></i> osquery use at scale

---

class: dark-purple, middle, right
# <i class="fa fa-caret-right"></i> osquery

---

# What is osquery?
## Expose system information via SQL tables
### <i class="fa fa-angle-right"></i> users, groups
### <i class="fa fa-angle-right"></i> installed packages, kernel modules
### <i class="fa fa-angle-right"></i> network communication, file system events
## Runs scheduled queries of tables

---

# The People
## <i class="fa fa-facebook-square"></i> Facebook
## <i class="fa fa-user"></i> @marpaia
## <i class="fa fa-user"></i> @theopolis
## <i class="fa fa-users"></i> Along with 63 other people as of this writing...

???
- Built off of Facebook's BigMac & Etsy's TripYarn tools (Combined as MIDAS)
- 2420 Total Commits, 1635 Pull Requests

---

class: middle
# What problems can osquery solve?
## <i class="fa fa-angle-right"></i> Single tool for finding system information
## <i class="fa fa-angle-right"></i> Easy to merge information from information sources
## <i class="fa fa-angle-right"></i> Results presented in multiple parsable format

---

class: middle
# How do you use osquery
## <i class="fa fa-angle-right"></i>Schedule a query
## <i class="fa fa-angle-right"></i>Collect the logs
## <i class="fa fa-angle-right"></i>Watch for changes

---

# Out of the Box Tools
.left-column[
### osqueryi]
.right-column[
## <i class="fa  fa-angle-double-right"></i> osquery's Run, Evaluate, Print, Loop
## <i class="fa  fa-angle-double-right"></i> Useful for testing & one off checks
]

---

# Out of the Box Tools
.left-column[
### osqueryi
### osqueryd]
.right-column[
## <i class="fa  fa-angle-double-right"></i> osquery's Daemon Tool
## <i class="fa  fa-angle-double-right"></i> Useful for continous detection
## <i class="fa  fa-angle-double-right"></i> Schedules and runs pre-set queries and writes them to a logger
## <i class="fa  fa-angle-double-right"></i> Takes some setup (we'll get to that)
]

---

# Out of the Box Tools
.left-column[
### osqueryi
### osqueryd
### osqueryctl]
.right-column[
## <i class="fa  fa-angle-double-right"></i> osquery's System Control Tool
## <i class="fa  fa-angle-double-right"></i> Turns osqueryd on, gets status, turns it off, etc
## <i class="fa  fa-angle-double-right"></i> Takes care of system specific stuff (like LaunchAgents, which aren't fun)
]

---

class: dark-purple, middle, right
# <i class="fa fa-caret-right"></i> osquery use

---

# Basic Configuration
.left-column[
### osquery.conf
]
.right-column[
## <i class="fa  fa-angle-double-right"></i> JSON configuration file
## <i class="fa  fa-angle-double-right"></i> holds the scheduled queries
## <i class="fa  fa-angle-double-right"></i> file paths to monitor
## <i class="fa  fa-angle-double-right"></i> read from local filesystem or https
]

---

# Basic Configuration
.left-column[
### osquery.conf
### flags.conf
]
.right-column[
## <i class="fa  fa-angle-double-right"></i> flags file configures administration
## <i class="fa  fa-angle-double-right"></i> where do logs go
## <i class="fa  fa-angle-double-right"></i> where is the pidfile
## <i class="fa  fa-angle-double-right"></i> where to find JSON config file
]

---

class: middle
# Query Syntax

```sql
SELECT columns FROM table WHERE modifier;
```

---

class: middle
# Basic Query
```sql
select * from apt_sources
```

???

- This is a Ubuntu only query.

---

class: middle
# Basic Syntax Breakdown

### <i class="fa fa-caret-right"></i> Get all the data columns
```sql
SELECT *
```

--

### <i class="fa fa-caret-right"></i> From the Apt Sources (as in apt-get)  Virtual Table
```sql
FROM apt_sources
```

---

class: middle
# Advanced Query
```sql
SELECT name & path FROM kernel_extensions WHERE name NOT LIKE 'com.apple%';
```

---

class: middle
# Advanced Syntax Breakdown

### <i class="fa fa-caret-right"></i> Get the name & and path data
```sql
SELECT name & path
```

--

### <i class="fa fa-caret-right"></i> From the Kernel Extensions virtual Table
```sql
FROM kernel_extensions
```

--

### <i class="fa fa-caret-right"></i> Where the name field doesn't start with `com.apple`
```sql
WHERE name NOT LIKE 'com.apple%'
```

---

class: middle
# Advanced Query
```sql
SELECT name & path FROM kernel_extensions WHERE name NOT LIKE 'com.apple%';
```

# What it means?
### Get the name, version, & path about any loaded OSX Kernel Extensions that were not created by Apple

---

# Joins

---

# Real World Query Examples

---
# Query Writing Philosophy

---

# Searching for:
## needles in haystacks (Scott) or looking for interesting  haystacks (Kevin)

---

class: middle
# Special Capabilities
## <i class="fa  fa-chevron-right"></i> File Integrity Monitoring
## <i class="fa  fa-chevron-right"></i> Yara

---

# File Integrity Monitoring
- Specify directory paths and wildcards
- Creates an inotify watcher
- Publishes changes to file_events table

---

# File Integrity Monitoring
## Specify paths to watch
```javascript
"file_paths": {
    "configuration": [
      "/etc/%%"
      ],
    "binaries": [
      "/usr/bin/%%",
      "/usr/sbin/%%",
      "/bin/%%",
      "/sbin/%%",
      "/usr/local/bin/%%",
      "/usr/local/sbin/%%",
      "/opt/bin/%%",
      "/opt/sbin/%%"
    ],
    "ssh_keys": [
        "/home/%/.ssh/authorized_keys"
      ]
  }
```

---
# File Integrity monitoring
```javascript
osqueryd[22331]: message=Added kernel listener to: /usr/bin/
osqueryd[22331]: message=Added kernel listener to: /usr/sbin/
osqueryd[22331]: message=Added kernel listener to: /bin/
osqueryd[22331]: message=Added kernel listener to: /sbin/
osqueryd[22331]: message=Added kernel listener to: /usr/local/bin/
osqueryd[22331]: message=Added kernel listener to: /usr/local/sbin/
osqueryd[22331]: message=Added kernel listener to: /opt/bin/
osqueryd[22331]: message=Added kernel listener to: /opt/sbin/
osqueryd[22331]: message=Added kernel listener to: /etc/
osqueryd[22331]: message=Added kernel listener to: /home/
```

---

# File Integrity Monitoring
## Write a scheduled query to collect
```javascript
"schedule": {
    "file_events": {
      "query": "select * from file_events;",
      "interval": 900,
      "removed":false
    }
  }
}
```

---
# File Integrity monitoring
```javascript
{
  "name": "file_events",
  "hostIdentifier": "ip-172-31-28-89",
  "calendarTime": "Tue Nov  3 19:53:38 2015 UTC",
  "unixTime": "1446580418",
  "columns": {
    "action": "CREATED",
    "category": "configuration",
    "md5": "d41d8cd98f00b204e9800998ecf8427e",
    "sha1": "da39a3ee5e6b4b0d3255bfef95601890afd80709",
    "sha256": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
    "slot": "default",
    "target_path": "/etc/test",
    "time": "1446579678",
    "transaction_id": "0"
  },
  "action": "added"
}
```

---
# Yara
## A pattern matching syntax for identifying malware
## osquery can be configured to compare changed files to a set of yara sigs
## This is a beta feature at this time

---
# Yara
## Start by setting up the file paths you want to watch just as before.
```javascript
"file_paths": {
    "binaries": [
      "/usr/bin/%%",
      "/usr/sbin/%%",
      "/bin/%%",
      "/sbin/%%",
      "/usr/local/bin/%%",
      "/usr/local/sbin/%%",
      "/opt/bin/%%",
      "/opt/sbin/%%"
    ]
  }
```

---
# Yara
## Then tell osquery which files contain yara sigs.
- Note the key, "binaries" has to be one of the file paths
```javascript
"yara": {
  "signatures": {
    "group_1": ["/path/file1.sig", "/path/file2.sig"],
    "group_2": ["/path/file2.sig", "/path/file3.sig"]
  },
  "binaries" : ["group_1"]
}
```

---
# Yara
## Since this is still beta, we aren't using this in production.
## Only in exploration right now.
## No idea what performance impact this has on a server.

---

# Managing Intelligence with Packs

---

# What Are Packs

---

# Why Packs?
---

# Building Your Own Packs

---

# Using Non-Facebook Packs

---

## ? Performance Impact & Testing ?
- heavy queries and how to avoid them
  - Might need to ask Mike/Teddy
- query profiler
- cgroups

---
# cgroups
## Control Groups: a feature of the linux kernel
- LXC uses cgroups to do it's work
- Allows you to segment a group of processes into their own process space or file system

---
# cgroups
## Root cgroup - everything runs here
- by default everything gets 1000 cpu shares
- smallest you can provide is 2 shares
- set up during init script

---
# cgroups
## Create the cgroups for memory and cpu
```bash
cgcreate -g cpu:osquery
cgcreate -g cpuacct:osquery
cgcreate -g memory:osquery
```

---
# cgroups
## Set the cpu and memory limits
```bash
cgset -r cpu.shares=2 osquery
cgset -r memory.limit_in_bytes=1073741824
cgset -r memory.kmem.limit_in_bytes=104857600
cgset -r memory.kmem.tcp.limit_in_bytes=104857600

cgexec -g cpuset:osquery osqueryd
```
---

class: dark-purple, middle, right
# <i class="fa fa-caret-right"></i> use osquery at scale

---

# How Heroku is Using osquery vs How GitHub is Using osquery

---

# Deploying osquery itself (puppet/chef)

---

# configuration management
  - ad hoc queries
- Introducing Windmill
- logging pipeline
- using those logs
- splunk (1/2 slides)
- elk & elastalert (1/2 slides)

---

class: dark-purple
## Resources
- osquery.io

---

## Notes/Ideas
- Kingsguard (Formerly GoldCloak) (If I get it done)
- Intel Management/Sharing/Generation

---

# Summary

---

# Thanks


    </textarea>
    <script src="https://gnab.github.io/remark/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create();
    </script>
  </body>
</html>
